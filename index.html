<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Panel Administrativo Global - Andy Obreg√≥n</title>
    
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-firestore.js"></script>

    <style>
        :root { --primary: #1e293b; --accent: #3b82f6; --danger: #ef4444; --success: #22c55e; --warning: #f59e0b; --text: #f8fafc; }
        body { font-family: 'Segoe UI', sans-serif; background: #0f172a; color: var(--text); margin: 0; padding-bottom: 50px; }
        
        /* Navbar */
        .navbar { display: flex; background: var(--primary); padding: 10px; gap: 5px; position: sticky; top: 0; z-index: 1000; overflow-x: auto; border-bottom: 2px solid var(--accent); }
        .nav-btn { background: #334155; color: white; border: none; padding: 10px; border-radius: 6px; cursor: pointer; font-weight: bold; white-space: nowrap; flex: 1; font-size: 0.75rem; }
        .nav-btn.active { background: var(--accent); }
        
        /* Contenedores */
        .container { padding: 15px; }
        .section { display: none; }
        .section.active { display: block; }
        .card { background: #1e293b; border-radius: 8px; padding: 15px; margin-bottom: 20px; border: 1px solid #334155; }
        
        /* Tablas */
        .table-container { width: 100%; overflow-x: auto; background: white; border-radius: 8px; margin-top: 10px; }
        table { width: 100%; border-collapse: collapse; color: #333; min-width: 650px; }
        th { background: #1e2d3b; color: white; padding: 12px; font-size: 0.75rem; text-transform: uppercase; }
        td { border-bottom: 1px solid #eee; padding: 10px; font-size: 0.8rem; text-align: center; }
        
        /* Inputs y Botones */
        input, select, textarea { background: #0f172a; border: 1px solid #475569; color: white; padding: 10px; border-radius: 5px; width: 100%; margin-bottom: 10px; box-sizing: border-box; }
        .btn-add { background: var(--success); color: white; width: 100%; padding: 12px; border: none; border-radius: 5px; font-weight: bold; cursor: pointer; }
        .action-btn { padding: 6px 10px; border: none; border-radius: 4px; color: white; cursor: pointer; font-size: 0.7rem; font-weight: bold; margin: 2px; }
        
        .cuenta-box { background: #f0fdf4; border: 2px dashed #22c55e; padding: 15px; margin: 10px 0; font-family: monospace; font-size: 1rem; color: #166534; word-break: break-all; text-align: center; border-radius: 8px; }
    </style>
</head>
<body>

<div id="main-content">
    <div class="navbar" id="barra-nav">
        <button class="nav-btn active" onclick="showTab('tab-usuario')">üì• PEDIR</button>
        <button class="nav-btn" onclick="showTab('tab-historial')">üïí HISTORIAL</button>
        <button class="nav-btn" onclick="showTab('tab-stock')">üì¶ STOCK/SOCIOS</button>
        <button class="nav-btn" style="background:var(--danger)" onclick="location.reload()">SALIR</button>
    </div>

    <div class="container">
        <div id="tab-usuario" class="section active">
            <div class="card">
                <h3>üéÅ Obtener mi Cuenta al Instante</h3>
                <input type="text" id="user-cliente-nom" placeholder="Nombre del Cliente">
                <select id="user-select-plat"></select>
                <button class="btn-add" onclick="reclamarCuenta()">üöÄ RECLAMAR CUENTA AHORA</button>
                <div id="display-entrega" style="display:none; margin-top:20px;">
                    <div style="font-weight: bold; text-align: center;">‚úÖ ENTREGA EXITOSA:</div>
                    <div class="cuenta-box" id="texto-cuenta"></div>
                </div>
            </div>
        </div>

        <div id="tab-historial" class="section">
            <div class="card">
                <h3>üìú Registro Global de Entregas</h3>
                <div class="table-container">
                    <table>
                        <thead>
                            <tr><th>Fecha</th><th>Socio</th><th>Cliente</th><th>Plataforma</th><th>Cuenta</th></tr>
                        </thead>
                        <tbody id="historial-body"></tbody>
                    </table>
                </div>
            </div>
        </div>

        <div id="tab-stock" class="section">
            <div class="card">
                <h3>üõ†Ô∏è Gestionar Plataformas</h3>
                <input type="text" id="nueva-plat-nombre" placeholder="Nombre (Ej: Netflix)">
                <button class="btn-add" style="background:var(--accent)" onclick="crearPlat()">+ CREAR</button>
                <div id="lista-plataformas" style="margin-top:10px;"></div>
            </div>
            
            <div class="card">
                <h3>üì¶ A√±adir Cuentas al Inventario</h3>
                <input type="text" id="st-cuenta" placeholder="correo:clave">
                <select id="st-plat-select"></select>
                <button class="btn-add" onclick="agregarStock()">GUARDAR EN NUBE</button>
            </div>

            <div class="card">
                <h3>üë• Gestionar Socios</h3>
                <input type="text" id="soc-nom" placeholder="Nombre">
                <input type="email" id="soc-cor" placeholder="Correo">
                <input type="text" id="soc-pas" placeholder="Contrase√±a">
                <button class="btn-add" style="background:var(--warning)" onclick="agregarSocio()">GUARDAR SOCIO</button>
            </div>
        </div>
    </div>
</div>

<script>
    // --- 1. CONFIGURACI√ìN FIREBASE (USANDO TUS LLAVES REALES) ---
    const firebaseConfig = {
        apiKey: "AIzaSyBXqBGXf8vOzPnbO7MDKEmhdvJsA3sFczA",
        authDomain: "sistema-grupo-privado.firebaseapp.com",
        projectId: "sistema-grupo-privado",
        storageBucket: "sistema-grupo-privado.firebasestorage.app",
        messagingSenderId: "86750167453",
        appId: "1:86750167453:web:165ff3a605105d525c6f74"
    };

    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();

    // --- 2. FUNCIONES DE ENTREGA ---
    async function reclamarCuenta() {
        const plat = document.getElementById('user-select-plat').value;
        const cliente = document.getElementById('user-cliente-nom').value;
        if(!cliente) return alert("Escribe el nombre del cliente");

        try {
            const query = await db.collection("inventario")
                .where("plataforma", "==", plat)
                .where("cupos", "<", 8)
                .limit(1).get();

            if (!query.empty) {
                const doc = query.docs[0];
                const data = doc.data();

                await db.collection("inventario").doc(doc.id).update({
                    cupos: data.cupos + 1
                });

                await db.collection("entregas").add({
                    cuenta: data.cuenta,
                    estado: "listo",
                    nombreWsp: cliente,
                    plataforma: plat,
                    timestamp: firebase.firestore.FieldValue.serverTimestamp(),
                    usuarioEmail: "ayuda@gmail.com"
                });

                document.getElementById('texto-cuenta').innerText = data.cuenta;
                document.getElementById('display-entrega').style.display = 'block';
            } else {
                alert("Sin stock de " + plat);
            }
        } catch (e) { alert("Error: Revisa tus reglas de Firebase"); }
    }

    // --- 3. FUNCIONES DE ADMINISTRACI√ìN ---
    async function crearPlat() {
        const n = document.getElementById('nueva-plat-nombre').value;
        if(n) await db.collection("plataformas").add({ nombre: n });
        document.getElementById('nueva-plat-nombre').value = "";
    }

    async function agregarStock() {
        const c = document.getElementById('st-cuenta').value;
        const p = document.getElementById('st-plat-select').value;
        if(c) await db.collection("inventario").add({ cuenta: c, plataforma: p, cupos: 0 });
        document.getElementById('st-cuenta').value = "";
        alert("Cuenta guardada");
    }

    async function agregarSocio() {
        const n = document.getElementById('soc-nom').value;
        const c = document.getElementById('soc-cor').value;
        const p = document.getElementById('soc-pas').value;
        if(n && c && p) await db.collection("users").add({ nombre: n, correo: c, pass: p, estado: true });
        alert("Socio guardado");
    }

    // --- 4. SINCRONIZACI√ìN EN TIEMPO REAL ---
    function sincronizarTodo() {
        // Cargar Plataformas
        db.collection("plataformas").onSnapshot(snap => {
            let options = "";
            let list = "";
            snap.forEach(doc => {
                const p = doc.data().nombre;
                options += `<option value="${p}">${p}</option>`;
                list += `<div style="display:flex; justify-content:space-between; background:#334155; padding:5px; margin-bottom:2px; border-radius:4px;">
                            <span>${p}</span>
                            <button class="action-btn" style="background:red" onclick="eliminarDoc('plataformas','${doc.id}')">X</button>
                         </div>`;
            });
            document.getElementById('user-select-plat').innerHTML = options;
            document.getElementById('st-plat-select').innerHTML = options;
            document.getElementById('lista-plataformas').innerHTML = list;
        });

        // Cargar Historial
        db.collection("entregas").orderBy("timestamp", "desc").limit(20).onSnapshot(snap => {
            let html = "";
            snap.forEach(doc => {
                const h = doc.data();
                const fecha = h.timestamp ? new Date(h.timestamp.seconds * 1000).toLocaleDateString() : "...";
                html += `<tr><td>${fecha}</td><td>${h.usuarioEmail}</td><td>${h.nombreWsp}</td><td>${h.plataforma}</td><td>${h.cuenta}</td></tr>`;
            });
            document.getElementById('historial-body').innerHTML = html;
        });
    }

    async function eliminarDoc(coleccion, id) {
        if(confirm("¬øEliminar?")) await db.collection(coleccion).doc(id).delete();
    }

    function showTab(id) {
        document.querySelectorAll('.section').forEach(s => s.classList.remove('active'));
        document.getElementById(id).classList.add('active');
        document.querySelectorAll('.nav-btn').forEach(b => b.classList.remove('active'));
        event.currentTarget.classList.add('active');
    }

    sincronizarTodo();
</script>
</body>
</html>
