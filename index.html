<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistema Privado - Acceso Restringido</title>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-firestore.js"></script>

    <style>
        :root { --primary: #1e293b; --accent: #3b82f6; --danger: #ef4444; --success: #22c55e; --text: #f8fafc; }
        body { font-family: 'Segoe UI', sans-serif; background: #0f172a; color: var(--text); margin: 0; }
        
        /* Pantalla de Login */
        #login-screen { display: flex; flex-direction: column; align-items: center; justify-content: center; height: 100vh; padding: 20px; }
        .login-card { background: var(--primary); padding: 30px; border-radius: 12px; width: 100%; max-width: 400px; box-shadow: 0 10px 25px rgba(0,0,0,0.5); }
        
        /* Panel Principal */
        #main-app { display: none; }
        .navbar { display: flex; background: var(--primary); padding: 10px; gap: 5px; position: sticky; top: 0; z-index: 1000; border-bottom: 2px solid var(--accent); }
        .nav-btn { background: #334155; color: white; border: none; padding: 10px; border-radius: 6px; cursor: pointer; flex: 1; font-size: 0.75rem; font-weight: bold; }
        .nav-btn.active { background: var(--accent); }
        .container { padding: 15px; }
        .section { display: none; }
        .section.active { display: block; }
        .card { background: #1e293b; border-radius: 8px; padding: 15px; margin-bottom: 20px; border: 1px solid #334155; }
        
        input, select { background: #0f172a; border: 1px solid #475569; color: white; padding: 12px; border-radius: 5px; width: 100%; margin-bottom: 10px; box-sizing: border-box; }
        .btn { background: var(--accent); color: white; width: 100%; padding: 12px; border: none; border-radius: 5px; font-weight: bold; cursor: pointer; }
        .btn-add { background: var(--success); }
        .btn-logout { background: var(--danger); margin-top: 10px; }
        
        .admin-only { display: none; } /* Oculto por defecto */
        .cuenta-box { background: #f0fdf4; border: 2px dashed #22c55e; padding: 15px; margin-top: 10px; color: #166534; text-align: center; border-radius: 8px; font-weight: bold; }
    </style>
</head>
<body>

<div id="login-screen">
    <div class="login-card">
        <h2 style="text-align:center">üîê Acceso al Sistema</h2>
        <input type="email" id="login-email" placeholder="Correo electr√≥nico">
        <input type="password" id="login-pass" placeholder="Contrase√±a">
        <button class="btn" onclick="iniciarSesion()">INGRESAR</button>
        <p id="login-error" style="color:red; font-size:0.8rem; text-align:center; margin-top:10px;"></p>
    </div>
</div>

<div id="main-app">
    <div class="navbar">
        <button class="nav-btn active" onclick="showTab('tab-pedir')">üì• PEDIR</button>
        <button class="nav-btn" onclick="showTab('tab-historial')">üïí HISTORIAL</button>
        <button class="nav-btn admin-only" id="btn-admin-tab" onclick="showTab('tab-admin')">‚öôÔ∏è GESTI√ìN</button>
        <button class="nav-btn" style="background:var(--danger)" onclick="cerrarSesion()">SALIR</button>
    </div>

    <div class="container">
        <div id="tab-pedir" class="section active">
            <div class="card">
                <h3>üöÄ Entrega de Cuentas</h3>
                <input type="text" id="cliente-nom" placeholder="Nombre del Cliente">
                <select id="select-plat"></select>
                <button class="btn btn-add" onclick="reclamarCuenta()">ENTREGAR AHORA</button>
                <div id="box-resultado" style="display:none" class="cuenta-box"></div>
            </div>
        </div>

        <div id="tab-historial" class="section">
            <div class="card">
                <h3>üìú Registro de Ventas</h3>
                <div id="lista-historial" style="font-size: 0.8rem;"></div>
            </div>
        </div>

        <div id="tab-admin" class="section">
            <div class="card">
                <h3>üõ†Ô∏è Crear Plataformas</h3>
                <input type="text" id="new-plat" placeholder="Ej: Netflix">
                <button class="btn" onclick="crearPlataforma()">+ CREAR</button>
            </div>
            <div class="card">
                <h3>üì¶ Cargar Inventario</h3>
                <input type="text" id="stock-mail" placeholder="correo:clave">
                <select id="stock-plat"></select>
                <button class="btn btn-add" onclick="subirStock()">GUARDAR CUENTA</button>
            </div>
            <div class="card">
                <h3>üë• Usuarios/Roles</h3>
                <input type="email" id="new-user-email" placeholder="Correo nuevo socio">
                <select id="new-user-role">
                    <option value="vendedor">Vendedor</option>
                    <option value="admin">Administrador</option>
                </select>
                <p style="font-size:0.7rem; color:gray">*El socio debe estar registrado en Auth primero.</p>
                <button class="btn" style="background:var(--success)" onclick="asignarRol()">ASIGNAR ROL</button>
            </div>
        </div>
    </div>
</div>

<script>
    // 1. CONFIGURACI√ìN (TUS DATOS)
    const firebaseConfig = {
        apiKey: "AIzaSyBXqBGXf8vOzPnbO7MDKEmhdvJsA3sFczA",
        authDomain: "sistema-grupo-privado.firebaseapp.com",
        projectId: "sistema-grupo-privado",
        storageBucket: "sistema-grupo-privado.firebasestorage.app",
        messagingSenderId: "86750167453",
        appId: "1:86750167453:web:165ff3a605105d525c6f74"
    };

    firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    const db = firebase.firestore();

    // 2. L√ìGICA DE ACCESO Y ROLES
    auth.onAuthStateChanged(user => {
        if (user) {
            checkUserRole(user);
        } else {
            document.getElementById('login-screen').style.display = 'flex';
            document.getElementById('main-app').style.display = 'none';
        }
    });

    async function checkUserRole(user) {
        const doc = await db.collection("users").doc(user.email).get();
        const userData = doc.data();

        document.getElementById('login-screen').style.display = 'none';
        document.getElementById('main-app').style.display = 'block';

        if (userData && userData.rol === 'admin') {
            document.querySelectorAll('.admin-only').forEach(el => el.style.display = 'block');
        } else {
            document.querySelectorAll('.admin-only').forEach(el => el.style.display = 'none');
        }
        sincronizarDatos();
    }

    // 3. FUNCIONES DE AUTH
    function iniciarSesion() {
        const email = document.getElementById('login-email').value;
        const pass = document.getElementById('login-pass').value;
        auth.signInWithEmailAndPassword(email, pass).catch(err => {
            document.getElementById('login-error').innerText = "Datos incorrectos";
        });
    }

    function cerrarSesion() { auth.signOut(); location.reload(); }

    // 4. FUNCIONES DE NEGOCIO
    async function reclamarCuenta() {
        const plat = document.getElementById('select-plat').value;
        const cliente = document.getElementById('cliente-nom').value;
        if(!cliente) return alert("Nombre del cliente?");

        const snap = await db.collection("inventario").where("plataforma","==",plat).where("cupos","<",8).limit(1).get();
        if(!snap.empty) {
            const doc = snap.docs[0];
            await db.collection("inventario").doc(doc.id).update({ cupos: doc.data().cupos + 1 });
            await db.collection("entregas").add({
                cuenta: doc.data().cuenta,
                cliente: cliente,
                plataforma: plat,
                socio: auth.currentUser.email,
                fecha: firebase.firestore.FieldValue.serverTimestamp()
            });
            document.getElementById('box-resultado').innerText = doc.data().cuenta;
            document.getElementById('box-resultado').style.display = 'block';
        } else { alert("Sin Stock"); }
    }

    // 5. FUNCIONES ADMIN
    async function crearPlataforma() {
        const n = document.getElementById('new-plat').value;
        if(n) await db.collection("plataformas").add({ nombre: n });
        document.getElementById('new-plat').value = "";
    }

    async function subirStock() {
        const c = document.getElementById('stock-mail').value;
        const p = document.getElementById('stock-plat').value;
        await db.collection("inventario").add({ cuenta: c, plataforma: p, cupos: 0 });
        alert("Guardado");
    }

    async function asignarRol() {
        const email = document.getElementById('new-user-email').value;
        const rol = document.getElementById('new-user-role').value;
        await db.collection("users").doc(email).set({ rol: rol });
        alert("Rol asignado a " + email);
    }

    // 6. SINCRONIZACI√ìN
    function sincronizarDatos() {
        db.collection("plataformas").onSnapshot(snap => {
            let h = "";
            snap.forEach(doc => h += `<option value="${doc.data().nombre}">${doc.data().nombre}</option>`);
            document.getElementById('select-plat').innerHTML = h;
            document.getElementById('stock-plat').innerHTML = h;
        });

        db.collection("entregas").orderBy("fecha","desc").limit(15).onSnapshot(snap => {
            let h = "";
            snap.forEach(doc => {
                const d = doc.data();
                h += `<div class="card" style="margin-bottom:5px; padding:10px; font-size:0.7rem">
                    <b>${d.cliente}</b> -> ${d.plataforma}<br>${d.cuenta}<br><small>${d.socio}</small>
                </div>`;
            });
            document.getElementById('lista-historial').innerHTML = h;
        });
    }

    function showTab(id) {
        document.querySelectorAll('.section').forEach(s => s.classList.remove('active'));
        document.getElementById(id).classList.add('active');
        document.querySelectorAll('.nav-btn').forEach(b => b.classList.remove('active'));
        event.currentTarget.classList.add('active');
    }
</script>
</body>
</html>
