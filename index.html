<script type="module">

import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
import { getAuth, signInWithEmailAndPassword, signOut, onAuthStateChanged, createUserWithEmailAndPassword }
from "https://www.gstatic.com/firebasejs/10.12.0/firebase-auth.js";
import { getFirestore, doc, setDoc, getDoc, addDoc, collection, onSnapshot }
from "https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js";

const firebaseConfig = {
  apiKey: "AIzaSyBXqBGXf8vOzPnbO7MDKEmhdvJsA3sFczA",
  authDomain: "sistema-grupo-privado.firebaseapp.com",
  projectId: "sistema-grupo-privado",
  storageBucket: "sistema-grupo-privado.firebasestorage.app",
  messagingSenderId: "86750167453",
  appId: "1:86750167453:web:165ff3a605105d525c6f74"
};

const appFirebase = initializeApp(firebaseConfig);
const auth = getAuth(appFirebase);
const db = getFirestore(appFirebase);

let rolActual = null;

/* ================= LOGIN ================= */
async function login(){
  try{
    await signInWithEmailAndPassword(
      auth,
      document.getElementById("email").value,
      document.getElementById("password").value
    );
  }catch(error){
    alert(error.message);
    console.log(error);
  }
}

/* ================= LOGOUT ================= */
function logout(){
  signOut(auth);
}

/* ================= CREAR USUARIO ================= */
async function crearUsuario(){
if(rolActual!=="admin"){ alert("No autorizado"); return; }

try{
const cred = await createUserWithEmailAndPassword(
auth,
document.getElementById("nuevoEmail").value,
document.getElementById("nuevoPassword").value
);

await setDoc(doc(db,"users",cred.user.uid),{
email:document.getElementById("nuevoEmail").value,
role:"usuario"
});

alert("Usuario creado correctamente");

}catch(error){
alert(error.message);
}
}

/* ================= AGREGAR ADMIN ================= */
async function agregarAdmin(){
if(rolActual!=="admin"){ alert("No autorizado"); return; }

await addDoc(collection(db,"adminsAyuda"),{
nombre:document.getElementById("nuevoAdminNombre").value
});

document.getElementById("nuevoAdminNombre").value="";
}

/* ================= AGREGAR PLATAFORMA ================= */
async function agregarPlataforma(){
if(rolActual!=="admin"){ alert("No autorizado"); return; }

await addDoc(collection(db,"plataformas"),{
nombre:document.getElementById("nuevaPlataforma").value
});

document.getElementById("nuevaPlataforma").value="";
}

/* ================= GUARDAR REGISTRO ================= */
async function guardarRegistro(){
await addDoc(collection(db,"cuentasActivadas"),{
plataforma:document.getElementById("selectPlataforma").value,
miembro:document.getElementById("miembro").value,
admin:document.getElementById("selectAdmin").value,
fecha:new Date().toLocaleString()
});

document.getElementById("miembro").value="";
}

/* ================= CARGAR SELECTS ================= */
function cargarSelects(){

onSnapshot(collection(db,"adminsAyuda"),(snapshot)=>{
const selectAdmin=document.getElementById("selectAdmin");
selectAdmin.innerHTML="";
snapshot.forEach(docu=>{
selectAdmin.innerHTML+=`<option>${docu.data().nombre}</option>`;
});
});

onSnapshot(collection(db,"plataformas"),(snapshot)=>{
const selectPlataforma=document.getElementById("selectPlataforma");
selectPlataforma.innerHTML="";
snapshot.forEach(docu=>{
selectPlataforma.innerHTML+=`<option>${docu.data().nombre}</option>`;
});
});
}

/* ================= HISTORIAL ================= */
function cargarHistorial(){
onSnapshot(collection(db,"cuentasActivadas"),(snapshot)=>{
const tabla=document.getElementById("tablaRegistros");
tabla.innerHTML="";
snapshot.forEach(docu=>{
const d=docu.data();
tabla.innerHTML+=`
<tr>
<td>${d.plataforma}</td>
<td>${d.miembro}</td>
<td>${d.admin}</td>
<td>${d.fecha}</td>
</tr>`;
});
});
}

/* ================= AUTH ================= */
onAuthStateChanged(auth, async(user)=>{
if(user){

const snap = await getDoc(doc(db,"users",user.uid));
rolActual = snap.exists() ? snap.data().role : "usuario";

document.getElementById("infoUsuario").innerText =
"Usuario: " + user.email + " | Rol: " + rolActual;

document.getElementById("loginBox").style.display="none";
document.getElementById("app").style.display="block";

if(rolActual==="admin"){
document.getElementById("panelAdmin").style.display="block";
}else{
document.getElementById("panelAdmin").style.display="none";
}

cargarSelects();
cargarHistorial();

}else{
document.getElementById("loginBox").style.display="block";
document.getElementById("app").style.display="none";
}
});

/* ================= EVENTOS ================= */
document.querySelector("#loginBox button").addEventListener("click", login);
document.querySelector(".logout").addEventListener("click", logout);
document.querySelector("#panelAdmin button:nth-of-type(1)").addEventListener("click", crearUsuario);
document.querySelector("#panelAdmin button:nth-of-type(2)").addEventListener("click", agregarAdmin);
document.querySelector("#panelAdmin button:nth-of-type(3)").addEventListener("click", agregarPlataforma);
document.querySelector("#app button:not(.logout)").addEventListener("click", guardarRegistro);

</script>